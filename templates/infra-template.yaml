# Infrastructure Specification Template
# Generated by /speckit.plan from Infrastructure Requirements section
# Used by /speckit.ship for provisioning

apiVersion: speckit.dev/v1
kind: InfrastructureSpec

metadata:
  # Feature identification
  feature: "{{FEATURE_ID}}"           # e.g., "001-user-auth"
  version: "1.0.0"                    # Increment on infrastructure changes
  created: "{{TIMESTAMP}}"
  updated: "{{TIMESTAMP}}"

  # Traceability to plan.md
  dependencies:
    - ref: "INFRA-001"                # Links to plan.md Infrastructure Requirements
    - ref: "INFRA-002"

# =============================================================================
# LOCAL ENVIRONMENT (docker-compose)
# =============================================================================
environments:
  local:
    provider: docker-compose
    description: "Local development environment"

    # Network configuration
    network:
      name: "{{PROJECT}}-local"
      driver: bridge

    # Infrastructure resources (databases, caches, queues)
    resources:
      # PostgreSQL Database
      - name: postgres
        type: database
        ref: INFRA-001                # Links to plan.md dependency
        image: postgres:16-alpine
        ports:
          - "5432:5432"
        environment:
          POSTGRES_DB: "{{PROJECT}}_dev"
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: localdev
        volumes:
          - postgres-data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U postgres"]
          interval: 10s
          timeout: 5s
          retries: 5

      # Redis Cache
      - name: redis
        type: cache
        ref: INFRA-002
        image: redis:7-alpine
        ports:
          - "6379:6379"
        command: redis-server --appendonly yes
        volumes:
          - redis-data:/data
        healthcheck:
          test: ["CMD", "redis-cli", "ping"]
          interval: 10s
          timeout: 5s
          retries: 5

      # RabbitMQ (optional - uncomment if needed)
      # - name: rabbitmq
      #   type: queue
      #   ref: INFRA-003
      #   image: rabbitmq:3-management-alpine
      #   ports:
      #     - "5672:5672"
      #     - "15672:15672"
      #   environment:
      #     RABBITMQ_DEFAULT_USER: guest
      #     RABBITMQ_DEFAULT_PASS: guest

      # MinIO (S3-compatible storage)
      # - name: minio
      #   type: storage
      #   ref: INFRA-004
      #   image: minio/minio:latest
      #   ports:
      #     - "9000:9000"
      #     - "9001:9001"
      #   command: server /data --console-address ":9001"
      #   environment:
      #     MINIO_ROOT_USER: minioadmin
      #     MINIO_ROOT_PASSWORD: minioadmin
      #   volumes:
      #     - minio-data:/data

    # Named volumes
    volumes:
      postgres-data: {}
      redis-data: {}
      # minio-data: {}

# =============================================================================
# STAGING ENVIRONMENT (Terraform + Kubernetes)
# =============================================================================
  staging:
    provider: terraform
    description: "Shared staging environment with feature namespaces"

    # Cloud provider configuration
    cloud: vk                         # vk | yandex | gcp
    region: ru-msk                    # Provider-specific region

    # Terraform backend (state storage)
    backend:
      type: s3                        # S3-compatible storage
      bucket: "{{PROJECT}}-tfstate"
      key: "staging/terraform.tfstate"
      region: ru-msk
      # VK Cloud S3 endpoint
      endpoint: "https://hb.bizmrg.com"
      # Yandex Cloud: endpoint: "https://storage.yandexcloud.net"
      # GCP: Use GCS backend instead

    # Terraform variables
    variables:
      project_name: "{{PROJECT}}"
      environment: staging
      # Network
      vpc_cidr: "10.0.0.0/16"
      # Common tags
      tags:
        project: "{{PROJECT}}"
        environment: staging
        managed_by: speckit

    # Infrastructure resources
    resources:
      # PostgreSQL Database (VK Cloud DBaaS)
      - name: postgres
        type: database
        ref: INFRA-001
        # VK Cloud module
        module: vkcs/dbaas
        # Yandex: module: yandex/managed-postgresql
        # GCP: module: google/sql-db
        vars:
          datastore_type: postgresql
          datastore_version: "16"
          flavor_id: Standard-4-8     # 4 vCPU, 8 GB RAM
          volume_size: 50             # GB
          volume_type: ceph-ssd
          backup_schedule: "0 3 * * *"
          # High availability (optional)
          # cluster_size: 3
          # ha_enable: true
        outputs:
          - name: database_host
            value: "{{resource.host}}"
          - name: database_port
            value: "{{resource.port}}"
          - name: database_name
            value: "{{resource.database}}"

      # Redis Cache (VK Cloud)
      - name: redis
        type: cache
        ref: INFRA-002
        module: vkcs/dbaas
        vars:
          datastore_type: redis
          datastore_version: "7"
          flavor_id: Standard-2-4     # 2 vCPU, 4 GB RAM
          volume_size: 10
        outputs:
          - name: redis_host
            value: "{{resource.host}}"
          - name: redis_port
            value: "{{resource.port}}"

      # Kubernetes Cluster (VK Cloud)
      - name: kubernetes
        type: compute
        ref: INFRA-005
        module: vkcs/kubernetes
        vars:
          cluster_name: "{{PROJECT}}-staging"
          k8s_version: "1.28"
          # Node pool
          node_count: 3
          node_flavor: Standard-4-8   # 4 vCPU, 8 GB RAM per node
          node_volume_size: 50
          # Autoscaling (optional)
          # min_node_count: 2
          # max_node_count: 5
          # Networking
          network_id: "{{vpc.id}}"
          subnet_id: "{{subnet.id}}"
        outputs:
          - name: kubernetes_endpoint
            value: "{{resource.api_endpoint}}"
          - name: kubeconfig
            value: "{{resource.kubeconfig}}"
            sensitive: true

      # S3 Bucket (VK Cloud Object Storage)
      - name: storage
        type: storage
        ref: INFRA-004
        module: vkcs/objectstorage
        vars:
          bucket_name: "{{PROJECT}}-staging-assets"
          versioning: true
          lifecycle_rules:
            - id: cleanup-old-versions
              enabled: true
              noncurrent_version_expiration:
                days: 30
        outputs:
          - name: s3_bucket
            value: "{{resource.bucket}}"
          - name: s3_endpoint
            value: "{{resource.endpoint}}"

    # Shared infrastructure (not recreated per feature)
    shared:
      - postgres     # Database is shared across features
      - redis        # Cache is shared
      - kubernetes   # Cluster is shared, features get namespaces

# =============================================================================
# PRODUCTION ENVIRONMENT
# =============================================================================
  production:
    provider: terraform
    description: "Production environment with high availability"

    cloud: vk
    region: ru-msk

    # Inherit staging configuration
    inherits: staging

    # Override backend
    backend:
      bucket: "{{PROJECT}}-tfstate"
      key: "production/terraform.tfstate"

    # Production-specific variables
    variables:
      environment: production
      tags:
        environment: production

    # Production resource overrides
    resources:
      # PostgreSQL - larger instance, HA enabled
      - name: postgres
        type: database
        ref: INFRA-001
        inherits: staging.postgres
        vars:
          flavor_id: Standard-8-16    # 8 vCPU, 16 GB RAM
          volume_size: 200
          cluster_size: 3             # HA cluster
          ha_enable: true

      # Redis - larger instance
      - name: redis
        type: cache
        ref: INFRA-002
        inherits: staging.redis
        vars:
          flavor_id: Standard-4-8
          cluster_mode: true

      # Kubernetes - more nodes, larger instances
      - name: kubernetes
        type: compute
        ref: INFRA-005
        inherits: staging.kubernetes
        vars:
          cluster_name: "{{PROJECT}}-production"
          node_count: 5
          node_flavor: Standard-8-16
          min_node_count: 3
          max_node_count: 10

# =============================================================================
# OUTPUT MAPPINGS
# =============================================================================
# These outputs are passed to deploy.yaml as environment variables

outputs:
  # Database connection
  DATABASE_HOST: "{{postgres.outputs.database_host}}"
  DATABASE_PORT: "{{postgres.outputs.database_port}}"
  DATABASE_NAME: "{{postgres.outputs.database_name}}"
  # Construct connection string in deploy.yaml

  # Redis connection
  REDIS_HOST: "{{redis.outputs.redis_host}}"
  REDIS_PORT: "{{redis.outputs.redis_port}}"

  # S3 storage
  S3_BUCKET: "{{storage.outputs.s3_bucket}}"
  S3_ENDPOINT: "{{storage.outputs.s3_endpoint}}"

  # Kubernetes
  KUBE_ENDPOINT: "{{kubernetes.outputs.kubernetes_endpoint}}"
