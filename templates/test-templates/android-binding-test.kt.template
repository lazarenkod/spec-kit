// Android Binding Test Template for KMP ViewModels
// Generated by spec-kit binding-test-generator
//
// Variables:
//   - package_name: Package name (e.g., "com.example.app")
//   - viewmodel_name: Name of the ViewModel (e.g., "AuthViewModel")
//   - wrapper_name: Name of the wrapper class (e.g., "AuthViewModelWrapper")
//   - methods: List of methods to test
//
// Usage:
//   This template generates JUnit binding tests for Android wrappers
//   that call KMP shared ViewModels.

package {{ package_name }}

import org.junit.Before
import org.junit.Test
import org.mockito.kotlin.*
import kotlin.test.assertEquals
import kotlin.test.assertTrue
{% if has_flow_methods %}
import app.cash.turbine.test
{% endif %}
{% if has_suspend_methods %}
import kotlinx.coroutines.test.runTest
{% endif %}
{% if has_flow_methods %}
import kotlinx.coroutines.flow.flowOf
{% endif %}

// @speckit:BINDING-TEST-FILE:{{ viewmodel_name }}
class {{ viewmodel_name }}BindingTest {
    private lateinit var mockViewModel: {{ viewmodel_name }}
    private lateinit var wrapper: {{ wrapper_name }}

    @Before
    fun setup() {
        mockViewModel = mock()
        wrapper = {{ wrapper_name }}(mockViewModel)
    }

    {% for method in methods %}
    {% if method.return_type == "Unit" and not method.is_suspend %}
    // @speckit:BINDING-TEST:{{ viewmodel_name }}:{{ method.name }}
    @Test
    fun `{{ method.name }} calls viewModel {{ method.name }}`() {
        // When
        wrapper.{{ method.name }}({% for param in method.parameters %}{{ param.name }} = {{ param.test_value }}{% if not loop.last %}, {% endif %}{% endfor %})

        // Then
        verify(mockViewModel).{{ method.name }}({% for param in method.parameters %}
            {{ param.name }} = {{ param.test_value }}{% if not loop.last %},{% endif %}{% endfor %}
        )
    }

    {% elif method.return_type == "Flow" %}
    // @speckit:BINDING-TEST:{{ viewmodel_name }}:{{ method.name }}
    @Test
    fun `{{ method.name }} emits viewModel flow values`() = runTest {
        // Given
        val expected{{ method.flow_type }} = {{ method.test_value }}
        whenever(mockViewModel.{{ method.name }}({% for param in method.parameters %}any(){% if not loop.last %}, {% endif %}{% endfor %})).thenReturn(flowOf(expected{{ method.flow_type }}))

        // When/Then
        wrapper.{{ method.name }}({% for param in method.parameters %}{{ param.name }} = {{ param.test_value }}{% if not loop.last %}, {% endif %}{% endfor %}).test {
            val item = awaitItem()
            assertEquals(expected{{ method.flow_type }}.id, item.id)
            awaitComplete()
        }

        verify(mockViewModel).{{ method.name }}({% for param in method.parameters %}
            {{ param.name }} = {{ param.test_value }}{% if not loop.last %},{% endif %}{% endfor %}
        )
    }

    {% elif method.is_suspend %}
    // @speckit:BINDING-TEST:{{ viewmodel_name }}:{{ method.name }}
    @Test
    fun `{{ method.name }} calls viewModel suspend function with correct args`() = runTest {
        // Given
        val expectedResult = {{ method.test_value }}
        whenever(mockViewModel.{{ method.name }}({% for param in method.parameters %}any(){% if not loop.last %}, {% endif %}{% endfor %})).thenReturn(expectedResult)

        // When
        val result = wrapper.{{ method.name }}({% for param in method.parameters %}{{ param.name }} = {{ param.test_value }}{% if not loop.last %}, {% endif %}{% endfor %})

        // Then
        verify(mockViewModel).{{ method.name }}({% for param in method.parameters %}
            {{ param.name }} = {{ param.test_value }}{% if not loop.last %},{% endif %}{% endfor %}
        )
        {% if method.return_type == "Result" %}
        assertTrue(result.isSuccess)
        assertEquals(expectedResult.getOrNull()?.id, result.getOrNull()?.id)
        {% else %}
        assertEquals(expectedResult.id, result.id)
        {% endif %}
    }

    {% else %}
    // @speckit:BINDING-TEST:{{ viewmodel_name }}:{{ method.name }}
    @Test
    fun `{{ method.name }} returns viewModel value`() {
        // Given
        val expectedValue = {{ method.test_value }}
        whenever(mockViewModel.{{ method.name }}({% for param in method.parameters %}any(){% if not loop.last %}, {% endif %}{% endfor %})).thenReturn(expectedValue)

        // When
        val result = wrapper.{{ method.name }}({% for param in method.parameters %}{{ param.name }} = {{ param.test_value }}{% if not loop.last %}, {% endif %}{% endfor %})

        // Then
        verify(mockViewModel).{{ method.name }}({% for param in method.parameters %}
            {{ param.name }} = {{ param.test_value }}{% if not loop.last %},{% endif %}{% endfor %}
        )
        assertEquals(expectedValue, result)
    }

    {% endif %}
    {% endfor %}
}
