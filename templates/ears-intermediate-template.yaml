# EARS Intermediate Representation Template
# Generated by /speckit.properties
#
# EARS = Easy Approach to Requirements Syntax
# Reference: https://ieeexplore.ieee.org/document/5328509
#
# This file captures the transformation from spec artifacts (AS, EC, FR, NFR)
# to EARS canonical forms, which are then used to derive testable properties.

apiVersion: speckit.dev/v1
kind: EarsIntermediate

metadata:
  feature: "{{FEATURE_ID}}"
  feature_branch: "{{FEATURE_BRANCH}}"
  generated: "{{TIMESTAMP}}"
  source_spec: "specs/{{FEATURE_ID}}/spec.md"
  generator_version: "0.0.76"

# =============================================================================
# EARS TYPE REFERENCE
# =============================================================================
#
# 1. UBIQUITOUS - System behavior without explicit trigger
#    Pattern: "The <system> SHALL <response>"
#    Source: FR-xxx without explicit triggers
#    Example: "The system SHALL validate all email addresses"
#
# 2. EVENT_DRIVEN - Behavior triggered by specific event
#    Pattern: "WHEN <trigger>, the <system> SHALL <response>"
#    Source: AS-xxx (Given/When/Then)
#    Example: "WHEN user submits form, the system SHALL create account"
#
# 3. STATE_DRIVEN - Behavior while system is in specific state
#    Pattern: "WHILE <state>, the <system> SHALL <behavior>"
#    Source: NFR-xxx with state conditions
#    Example: "WHILE under load, the system SHALL respond in <200ms"
#
# 4. UNWANTED - Behavior to prevent unwanted situations
#    Pattern: "IF <trigger>, THEN the <system> SHALL <mitigation>"
#    Source: EC-xxx (security, boundary, validation)
#    Example: "IF SQL injection detected, THEN the system SHALL reject"
#
# 5. OPTION - Behavior when optional feature is included
#    Pattern: "WHERE <feature>, the <system> SHALL <response>"
#    Source: Optional features, feature flags
#    Example: "WHERE premium enabled, the system SHALL show analytics"
#
# =============================================================================

# Summary statistics
summary:
  total_transformations: 0
  by_type:
    ubiquitous: 0
    event_driven: 0
    state_driven: 0
    unwanted: 0
    option: 0
  by_source:
    FR: 0
    AS: 0
    EC: 0
    NFR: 0
  transformation_coverage: 0.0  # % of artifacts successfully transformed
  average_confidence: 0.0
  ambiguities_detected: 0

# =============================================================================
# TRANSFORMATIONS
# =============================================================================

transformations:
  # ---------------------------------------------------------------------------
  # Example: Event-Driven (from Acceptance Scenario)
  # ---------------------------------------------------------------------------
  - id: EARS-001
    type: event_driven

    source:
      artifact: AS-1A
      artifact_type: acceptance_scenario
      classification: HAPPY_PATH
      original_text: |
        Given a user is on the registration page
        When they submit valid email and password
        Then an account is created and welcome email is sent
      location: "spec.md:89"

    ears_form:
      # Event-driven pattern components
      trigger: "user submits valid email and password on registration page"
      precondition: "user is on registration page"
      action: "create account"
      outcome: "account exists with submitted email AND welcome email is sent"

      # Full EARS statement
      statement: |
        WHEN user submits valid email and password on registration page,
        the system SHALL create an account AND send welcome email.

    properties_derived:
      - id: PROP-001
        type: inverse
        formula: "delete(create(user)) == no_user"
        confidence: 0.95
      - id: PROP-004
        type: idempotent
        formula: "register(email); register(email) == DuplicateError"
        confidence: 0.90

    confidence: 0.95
    ambiguity_notes: []

    # Traceability
    trace:
      functional_requirements: [FR-001]
      edge_cases: []
      nfr: []

  # ---------------------------------------------------------------------------
  # Example: Unwanted (from Edge Case)
  # ---------------------------------------------------------------------------
  - id: EARS-002
    type: unwanted

    source:
      artifact: EC-001
      artifact_type: edge_case
      severity: HIGH
      category: validation
      original_text: "Invalid email format must be rejected"
      location: "spec.md:175"

    ears_form:
      # Unwanted pattern components
      condition: "email does not match RFC 5322 pattern"
      trigger: "user attempts registration with invalid email"
      mitigation: "reject registration"
      safe_state: "no account created, ValidationError returned"

      # Full EARS statement
      statement: |
        IF email does not match RFC 5322 pattern,
        THEN the system SHALL reject registration with ValidationError.

    properties_derived:
      - id: PROP-003
        type: boundary
        formula: "forall invalid_email: register(email) -> ValidationError"
        confidence: 0.92

    confidence: 0.90
    ambiguity_notes:
      - "RFC 5322 compliance level not specified (strict vs lenient)"

    trace:
      functional_requirements: [FR-001]
      edge_cases: [EC-001]
      nfr: []

  # ---------------------------------------------------------------------------
  # Example: State-Driven (from NFR)
  # ---------------------------------------------------------------------------
  - id: EARS-003
    type: state_driven

    source:
      artifact: NFR-PERF-001
      artifact_type: nfr
      category: performance
      original_text: "API response time MUST be <200ms p95 under normal load"
      location: "spec.md:322"

    ears_form:
      # State-driven pattern components
      state: "concurrent users <= 1000 (normal load)"
      constraint: "response time p95 < 200ms"
      behavior: "respond to API requests"

      # Full EARS statement
      statement: |
        WHILE concurrent users <= 1000,
        the system SHALL respond to API requests in <200ms at p95.

    properties_derived:
      - id: PROP-002
        type: invariant
        formula: "forall request under_normal_load: latency_p95 < 200ms"
        confidence: 0.88

    confidence: 0.88
    ambiguity_notes:
      - "Definition of 'normal load' should be quantified"

    trace:
      functional_requirements: []
      edge_cases: []
      nfr: [NFR-PERF-001]

  # ---------------------------------------------------------------------------
  # Example: Ubiquitous (from FR without trigger)
  # ---------------------------------------------------------------------------
  - id: EARS-004
    type: ubiquitous

    source:
      artifact: FR-002
      artifact_type: functional_requirement
      original_text: "System MUST validate email addresses"
      location: "spec.md:278"

    ears_form:
      # Ubiquitous pattern (no trigger/state)
      action: "validate email addresses"
      constraint: "RFC 5322 compliance"

      # Full EARS statement
      statement: |
        The system SHALL validate all email addresses against RFC 5322.

    properties_derived:
      - id: PROP-005
        type: invariant
        formula: "forall email in system: is_valid_rfc5322(email)"
        confidence: 0.85

    confidence: 0.85
    ambiguity_notes: []

    trace:
      functional_requirements: [FR-002]
      edge_cases: [EC-001]
      nfr: []

  # ---------------------------------------------------------------------------
  # Example: Option (from optional feature)
  # ---------------------------------------------------------------------------
  - id: EARS-005
    type: option

    source:
      artifact: FR-010
      artifact_type: functional_requirement
      original_text: "Premium users can access advanced analytics"
      location: "spec.md:290"

    ears_form:
      # Option pattern
      feature_condition: "premium subscription is active"
      action: "enable advanced analytics dashboard"

      # Full EARS statement
      statement: |
        WHERE premium subscription is active,
        the system SHALL enable advanced analytics dashboard.

    properties_derived:
      - id: PROP-010
        type: invariant
        formula: "forall user where premium: can_access_analytics(user)"
        confidence: 0.82

    confidence: 0.82
    ambiguity_notes:
      - "Premium tier levels not specified"

    trace:
      functional_requirements: [FR-010]
      edge_cases: []
      nfr: []

  # ---------------------------------------------------------------------------
  # Example: Security Unwanted (from security edge case)
  # ---------------------------------------------------------------------------
  - id: EARS-006
    type: unwanted

    source:
      artifact: EC-002
      artifact_type: edge_case
      severity: CRITICAL
      category: security
      original_text: "SQL injection in email field must be prevented"
      location: "spec.md:177"

    ears_form:
      condition: "email input contains SQL injection patterns"
      trigger: "user submits registration with malicious email"
      mitigation: "sanitize input AND reject with ValidationError"
      safe_state: "no SQL executed, no account created"

      statement: |
        IF email input contains SQL injection patterns,
        THEN the system SHALL sanitize input AND reject with ValidationError,
        ensuring no SQL is executed.

    properties_derived:
      - id: PROP-006
        type: boundary
        formula: "forall sql_payload: register(sql_payload) -> ValidationError AND no_sql_executed"
        confidence: 0.98
        security_category: "OWASP A03:2021 Injection"

    confidence: 0.98
    ambiguity_notes: []

    trace:
      functional_requirements: [FR-001]
      edge_cases: [EC-002]
      nfr: [NFR-SEC-001]

# =============================================================================
# ENTITY ANALYSIS (for generator creation)
# =============================================================================

entities:
  - name: User
    description: "User account entity"
    source_location: "spec.md:442"

    attributes:
      - name: email
        type: string
        constraints:
          - "RFC 5322 format"
          - "unique across system"
          - "max 254 characters"
        valid_generator: "emails()"
        boundary_generator: |
          one_of(
            just(""),
            just("@"),
            just("a@"),
            text().filter(lambda x: "@" not in x)
          )
        security_generator: |
          one_of(
            just("'; DROP TABLE users; --"),
            just("' OR '1'='1"),
            sql_injection_payloads()
          )

      - name: password
        type: string
        constraints:
          - "minimum 8 characters"
          - "at least 1 uppercase"
          - "at least 1 lowercase"
          - "at least 1 digit"
        valid_generator: |
          text(min_size=8, max_size=128).filter(
            lambda p: any(c.isupper() for c in p) and
                      any(c.islower() for c in p) and
                      any(c.isdigit() for c in p)
          )
        boundary_generator: |
          one_of(
            just(""),
            text(max_size=7),
            just("password"),
            just("PASSWORD1"),
            just("Password")
          )

      - name: name
        type: string
        constraints:
          - "1-100 characters"
          - "non-empty"
        valid_generator: "text(min_size=1, max_size=100)"
        boundary_generator: |
          one_of(
            just(""),
            text(min_size=101)
          )

    relationships:
      - to: Account
        type: one-to-one
        cardinality: "1:1"

# =============================================================================
# AMBIGUITY SUMMARY
# =============================================================================

ambiguities:
  - id: AMB-001
    source: EARS-002
    description: "RFC 5322 compliance level not specified"
    impact: MEDIUM
    suggested_clarification: "Should email validation use strict or lenient RFC 5322 parsing?"
    affects_properties: [PROP-003, PROP-005]

  - id: AMB-002
    source: EARS-003
    description: "Normal load definition not quantified"
    impact: LOW
    suggested_clarification: "Specify exact concurrent user range for 'normal load'"
    affects_properties: [PROP-002]

# =============================================================================
# VALIDATION SUMMARY
# =============================================================================

validation:
  ears_coverage:
    total_artifacts: 10
    transformed: 9
    failed: 1
    coverage_percent: 90.0

  property_derivation:
    total_ears: 6
    with_properties: 6
    total_properties: 10
    average_properties_per_ears: 1.67

  confidence_distribution:
    high: 4      # >= 0.90
    medium: 2    # 0.70 - 0.89
    low: 0       # < 0.70

  quality_gates:
    VG-EARS:
      status: PASS
      value: 90.0
      threshold: 85.0
