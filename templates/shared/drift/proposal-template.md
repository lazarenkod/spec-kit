# Proposal Template for Drift Fix

**Purpose**: Define proposal structure, display format, and user interaction patterns for `/speckit.fix` Wave 3 (Proposal Generation) and Wave 4 (User Interaction).

**Version**: 1.0.0
**Last Updated**: 2026-01-11

---

## Table of Contents

1. [Overview](#overview)
2. [Proposal Types](#proposal-types)
3. [Proposal Schema](#proposal-schema)
4. [Display Format](#display-format)
5. [Diff Rendering](#diff-rendering)
6. [Confidence Scoring](#confidence-scoring)
7. [User Response Handling](#user-response-handling)
8. [Proposal Examples](#proposal-examples)
9. [Batch Proposals](#batch-proposals)
10. [Session State Management](#session-state-management)

---

## Overview

Proposals are structured change recommendations generated by Wave 3 subagents (spec-proposer, plan-proposer, tasks-proposer). Each proposal describes:
- **What** to change
- **Why** it should be changed
- **How** to apply the change
- **Confidence** in the recommendation

In **interactive mode**, proposals are displayed to the user one by one for approval. In **auto mode**, all proposals are applied automatically (with `--force` flag).

---

## Proposal Types

### Spec.md Proposals

| Type | Description | Example |
|------|-------------|---------|
| `ADD_FR` | Add new functional requirement | Undocumented API â†’ new FR-009 |
| `UPDATE_FR` | Modify existing FR (behavioral drift) | FR-003 description outdated |
| `REMOVE_FR` | Delete unimplemented FR | FR-007 never implemented |
| `MOVE_FR_TO_OUT_OF_SCOPE` | Move FR to Â§ Out of Scope | FR-005 removed from code |
| `ADD_AS` | Add new acceptance scenario | New test â†’ AS-9A |
| `UPDATE_AS` | Modify existing AS | AS-3B steps changed |
| `REMOVE_AS` | Delete obsolete AS | AS-7C no longer valid |

### Plan.md Proposals

| Type | Description | Example |
|------|-------------|---------|
| `ADD_PHASE` | Add new implementation phase | New FR-009 â†’ P3c |
| `UPDATE_PHASE` | Modify existing phase | P2a dependencies changed |
| `ADD_DEPENDENCY` | Add to Dependency Registry | New API-009 |
| `ADD_ADR` | Add architecture decision record | New ADR-004: Use Redis for caching |

### Tasks.md Proposals

| Type | Description | Example |
|------|-------------|---------|
| `ADD_TASK` | Add new task | [FR:FR-009] Implement archival endpoint |
| `ADD_TEST_TASK` | Add test task | [TEST:AS-9A] Test archival happy path |
| `UPDATE_TASK_DEPS` | Update task dependencies | Add [DEP:T020] to T021 |
| `MARK_TASK_OBSOLETE` | Mark task as obsolete | T015 no longer needed |

### Code Proposals

| Type | Description | Example |
|------|-------------|---------|
| `ADD_ANNOTATION` | Add @speckit annotation | @speckit:FR:FR-009 to archiveUser() |
| `UPDATE_ANNOTATION` | Fix incorrect annotation | @speckit:FR:FR-003 â†’ FR-009 |
| `REMOVE_ORPHAN_ANNOTATION` | Remove orphan annotation | @speckit:FR:FR-999 (doesn't exist) |

### System Spec Proposals

| Type | Description | Example |
|------|-------------|---------|
| `UPDATE_SYSTEM_SPEC` | Append to system spec history | Add row to spec_history |
| `UPDATE_CURRENT_BEHAVIOR` | Update current behavior section | Add new FR-009 to behavior |

---

## Proposal Schema

### Base Proposal Structure

```json
{
  "id": "PROP-001",
  "type": "ADD_FR",
  "artifact": "spec.md",
  "severity": "HIGH",
  "confidence": 0.85,
  "source": {
    "type": "reverse_drift",
    "drift_item_id": "RD-003",
    "file": "src/api/users.ts",
    "line": 142,
    "symbol": "archiveUser"
  },
  "current_state": {
    "description": "API exists but not documented",
    "evidence": [
      "Function archiveUser found at src/api/users.ts:142",
      "No @speckit:FR: annotation",
      "No corresponding FR in spec.md"
    ]
  },
  "proposed_change": {
    "action": "add",
    "target": "spec.md Â§ Functional Requirements",
    "content": {
      "fr_id": "FR-009",
      "description": "User can archive their account",
      "requirement": "The system MUST provide an API endpoint to archive user accounts...",
      "rationale": "Users need ability to deactivate without full deletion for GDPR compliance"
    }
  },
  "secondary_changes": [
    {
      "type": "ADD_ANNOTATION",
      "file": "src/api/users.ts",
      "line": 142,
      "annotation": "@speckit:FR:FR-009"
    }
  ],
  "impact": {
    "files_affected": ["spec.md", "src/api/users.ts"],
    "traceability": ["FR-009", "AS-9A"],
    "risk": "LOW"
  },
  "diff": {
    "format": "unified",
    "content": "..."
  }
}
```

---

### Field Descriptions

#### Core Fields

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Unique proposal ID (PROP-001, PROP-002, ...) |
| `type` | enum | Proposal type (ADD_FR, UPDATE_FR, etc.) |
| `artifact` | string | Target artifact (spec.md, plan.md, tasks.md, code) |
| `severity` | enum | CRITICAL \| HIGH \| MEDIUM \| LOW |
| `confidence` | float | 0.0-1.0 (confidence score) |

#### Source Context

| Field | Type | Description |
|-------|------|-------------|
| `source.type` | enum | reverse_drift \| forward_drift \| behavioral_drift \| orphan_annotation |
| `source.drift_item_id` | string | Reference to drift item (RD-003, FD-001, BD-002) |
| `source.file` | string | Source code file path |
| `source.line` | int | Line number in source file |
| `source.symbol` | string | Function/class name |

#### Current State

| Field | Type | Description |
|-------|------|-------------|
| `current_state.description` | string | Summary of current state |
| `current_state.evidence` | array | List of evidence items |

#### Proposed Change

| Field | Type | Description |
|-------|------|-------------|
| `proposed_change.action` | enum | add \| update \| remove \| move |
| `proposed_change.target` | string | Where to apply change |
| `proposed_change.content` | object | Change-specific data |

#### Secondary Changes

Array of additional changes required (e.g., add annotation after adding FR)

#### Impact Assessment

| Field | Type | Description |
|-------|------|-------------|
| `impact.files_affected` | array | List of files that will be modified |
| `impact.traceability` | array | FR/AS IDs involved |
| `impact.risk` | enum | LOW \| MEDIUM \| HIGH |

#### Diff

| Field | Type | Description |
|-------|------|-------------|
| `diff.format` | string | unified \| side-by-side |
| `diff.content` | string | Unified diff format |

---

## Display Format

### Interactive Mode Display

For each proposal in interactive mode, display:

```text
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Proposal {current}/{total}: {type}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{SEVERITY_BADGE} {TYPE_BADGE} {CONFIDENCE_BADGE}

## Summary
{proposed_change.description}

## Current State
{current_state.description}

Evidence:
{for item in current_state.evidence}
  â€¢ {item}
{endfor}

## Proposed Change
Target: {proposed_change.target}
Action: {proposed_change.action}

{DISPLAY_CHANGE_DETAILS}

{if secondary_changes}
## Secondary Changes
{for change in secondary_changes}
  {change.type} â†’ {change.file}:{change.line}
{endfor}
{endif}

## Impact
Files affected: {join(impact.files_affected)}
Traceability: {join(impact.traceability)}
Risk: {impact.risk}

## Diff Preview
{RENDER_DIFF(diff)}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Apply this change? [Y/n/e/skip/quit]
  Y    - Apply this proposal
  n    - Reject this proposal
  e    - Edit proposal before applying
  skip - Skip all remaining proposals for this artifact
  quit - Cancel entire fix session
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

### Severity Badges

```text
CRITICAL: ğŸ”´ CRITICAL
HIGH:     ğŸŸ  HIGH
MEDIUM:   ğŸŸ¡ MEDIUM
LOW:      ğŸŸ¢ LOW
```

---

### Type Badges

```text
ADD_FR:     [+ ADD FR]
UPDATE_FR:  [â†» UPDATE FR]
REMOVE_FR:  [- REMOVE FR]
MOVE_FR_TO_OUT_OF_SCOPE: [â‡„ MOVE FR]
ADD_AS:     [+ ADD AS]
ADD_ANNOTATION: [@ ANNOTATE]
ADD_PHASE:  [+ ADD PHASE]
ADD_TASK:   [+ ADD TASK]
```

---

### Confidence Badges

```text
0.90-1.00: âœ… Very High (0.95)
0.75-0.89: âœ“  High (0.82)
0.50-0.74: ~  Medium (0.67)
0.25-0.49: ?  Low (0.43)
0.00-0.24: âš   Very Low (0.15)
```

---

### Change Details Display

#### For ADD_FR

```text
New Functional Requirement:

  FR-009: User can archive their account

  Description:
    The system MUST provide an API endpoint to archive user accounts.
    Archived accounts are hidden from search and login is disabled, but
    data is retained for 30 days to allow recovery.

  Rationale:
    Users need ability to deactivate without full deletion for GDPR compliance.

  Related:
    â€¢ API: POST /api/v1/users/:id/archive
    â€¢ Implementation: src/api/users.ts:142
```

---

#### For UPDATE_FR

```text
Modify Existing Requirement:

  FR-003: User authentication via JWT

  Current:
    "The system MUST return 401 Unauthorized for invalid credentials."

  Proposed:
    "The system MUST return 403 Forbidden for invalid credentials."

  Reason:
    Code implementation returns 403 (not 401). Updating spec to match reality.
```

---

#### For MOVE_FR_TO_OUT_OF_SCOPE

```text
Move to Out of Scope:

  FR-007: Email notifications for account changes

  Reason:
    FR-007 was never implemented in code and has no tests. Moving to
    Â§ Out of Scope for future consideration.

  Rationale:
    Email service not yet integrated. Defer until Phase 3.
```

---

#### For ADD_ANNOTATION

```text
Add Traceability Annotation:

  File: src/api/users.ts
  Line: 142
  Symbol: archiveUser

  Annotation:
    // @speckit:FR:FR-009 User can archive account
    export async function archiveUser(userId: string) {
      ...
    }

  Purpose:
    Link code to new FR-009 for traceability.
```

---

## Diff Rendering

### Unified Diff Format

```diff
--- spec.md (original)
+++ spec.md (modified)
@@ -45,6 +45,15 @@

 ## Functional Requirements

+### FR-009: User Account Archival
+
+**Description**: User can archive their account to temporarily deactivate it.
+
+**Requirement**: The system MUST provide an API endpoint `POST /api/v1/users/:id/archive` that allows users to archive their account. Archived accounts are hidden from search and login is disabled.
+
+**Rationale**: Users need ability to deactivate without full deletion for GDPR compliance.
+
+---
+
 ### FR-001: User Registration

 **Description**: New users can create an account.
```

---

### Side-by-Side Diff (Optional)

```text
spec.md (original)                â”‚ spec.md (modified)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                  â”‚
## Functional Requirements        â”‚ ## Functional Requirements
                                  â”‚
                                  â”‚ ### FR-009: User Account Archival
                                  â”‚
                                  â”‚ **Description**: User can archive...
                                  â”‚
                                  â”‚ ---
                                  â”‚
### FR-001: User Registration     â”‚ ### FR-001: User Registration
```

---

### Diff Color Codes (Terminal)

```text
+ Added lines:   GREEN
- Removed lines: RED
@ Context:       CYAN
  Unchanged:     WHITE/GRAY
```

---

## Confidence Scoring

### Confidence Calculation

```text
ESTIMATE_CONFIDENCE(proposal):
  confidence = 0.0

  # Factor 1: Annotation exists (50%)
  IF has_annotation(@speckit:FR: or [TEST:AS-]):
    confidence += 0.50
  ELSE:
    confidence += 0.0

  # Factor 2: Tests exist (20%)
  IF has_tests(full_coverage):
    confidence += 0.20
  ELIF has_tests(partial_coverage):
    confidence += 0.10
  ELSE:
    confidence += 0.0

  # Factor 3: Naming clarity (15%)
  naming_clarity = LLM_EVALUATE(symbol_name, context)
  confidence += 0.15 * naming_clarity

  # Factor 4: Documentation (10%)
  IF has_docstring:
    confidence += 0.10
  ELIF has_inline_comments:
    confidence += 0.05
  ELSE:
    confidence += 0.0

  # Factor 5: Pattern matching (5%)
  IF matches_known_pattern(REST_API, CRUD, etc.):
    confidence += 0.05
  ELSE:
    confidence += 0.0

  RETURN MIN(confidence, 1.0)
```

---

### Confidence Display

```text
Confidence: âœ… Very High (0.95)

Factors:
  âœ… Has @speckit:FR:FR-003 annotation          +0.50
  âœ… Full test coverage (3 tests)                +0.20
  âœ“  Clear naming (archiveUser)                 +0.12
  âœ“  Docstring present                          +0.10
  âœ“  Matches REST API pattern                   +0.05
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total: 0.97
```

---

### Confidence Thresholds

| Threshold | Action | Recommendation |
|-----------|--------|----------------|
| â‰¥ 0.90 | Auto-apply (if `--mode auto`) | Very safe |
| 0.75-0.89 | Recommend approval | Safe |
| 0.50-0.74 | Neutral | Review carefully |
| 0.25-0.49 | Recommend rejection | Uncertain |
| < 0.25 | Auto-reject (if `--mode auto`) | Very uncertain |

---

## User Response Handling

### Response Options

| Input | Action | Description |
|-------|--------|-------------|
| `Y` or `y` or `yes` or `<Enter>` | Approve | Apply this proposal |
| `n` or `no` | Reject | Skip this proposal |
| `e` or `edit` | Edit | Open editor to modify proposal |
| `skip` | Skip all | Skip all remaining proposals for this artifact |
| `quit` or `q` | Cancel | Cancel entire fix session |

---

### Response Flow

```text
HANDLE_USER_RESPONSE(proposal):
  response = PROMPT("Apply this change? [Y/n/e/skip/quit]: ")

  CASE response:
    "Y" | "y" | "yes" | "":
      approved_proposals.append(proposal)
      OUTPUT("âœ… Approved")
      RETURN "continue"

    "n" | "no":
      rejected_proposals.append(proposal)
      OUTPUT("âŒ Rejected")
      RETURN "continue"

    "e" | "edit":
      edited_proposal = OPEN_EDITOR(proposal)
      approved_proposals.append(edited_proposal)
      OUTPUT("âœ… Approved (edited)")
      RETURN "continue"

    "skip":
      OUTPUT("â­ï¸  Skipping all remaining proposals for {proposal.artifact}")
      RETURN "skip_artifact"

    "quit" | "q":
      OUTPUT("ğŸ›‘ Canceling fix session")
      SAVE_SESSION_STATE()
      RETURN "cancel_session"

    DEFAULT:
      OUTPUT("Invalid input. Please enter Y/n/e/skip/quit")
      RETURN HANDLE_USER_RESPONSE(proposal)
```

---

### Edit Mode

When user selects `e` (edit):

```text
OPEN_EDITOR(proposal):
  # Step 1: Write proposal to temp file
  temp_file = "/tmp/speckit-fix-proposal-{proposal.id}.json"
  WRITE(temp_file, JSON_STRINGIFY(proposal, indent=2))

  # Step 2: Open in editor
  editor = ENV["EDITOR"] || "nano"
  EXEC(f"{editor} {temp_file}")

  # Step 3: Read edited proposal
  edited_content = READ(temp_file)
  edited_proposal = JSON_PARSE(edited_content)

  # Step 4: Validate edited proposal
  IF NOT VALIDATE_PROPOSAL(edited_proposal):
    ERROR("Invalid proposal format. Reverting to original.")
    RETURN proposal
  ELSE:
    OUTPUT("Proposal edited successfully")
    RETURN edited_proposal
```

---

### Skip Artifact Mode

When user selects `skip`, all remaining proposals for that artifact are skipped:

```text
IF response == "skip":
  FOR remaining_proposal IN proposals:
    IF remaining_proposal.artifact == current_proposal.artifact:
      skipped_proposals.append(remaining_proposal)
      OUTPUT(f"â­ï¸  Skipped {remaining_proposal.id}")

  # Continue to next artifact
  NEXT_ARTIFACT()
```

---

### Cancel Session Mode

When user selects `quit`:

```text
IF response == "quit":
  # Save session state to resume later
  session_state = {
    "timestamp": NOW(),
    "approved_proposals": approved_proposals,
    "rejected_proposals": rejected_proposals,
    "pending_proposals": remaining_proposals
  }

  WRITE(".fix-session.yaml", YAML_STRINGIFY(session_state))

  OUTPUT("Session state saved to .fix-session.yaml")
  OUTPUT("Resume with: /speckit.fix --resume")

  EXIT(0)
```

---

## Proposal Examples

### Example 1: ADD_FR Proposal

```json
{
  "id": "PROP-001",
  "type": "ADD_FR",
  "artifact": "spec.md",
  "severity": "HIGH",
  "confidence": 0.82,
  "source": {
    "type": "reverse_drift",
    "drift_item_id": "RD-003",
    "file": "src/api/users.ts",
    "line": 142,
    "symbol": "archiveUser"
  },
  "current_state": {
    "description": "API exists but not documented in spec",
    "evidence": [
      "Function archiveUser found at src/api/users.ts:142",
      "No @speckit:FR: annotation",
      "No corresponding FR in spec.md",
      "3 tests reference this function"
    ]
  },
  "proposed_change": {
    "action": "add",
    "target": "spec.md Â§ Functional Requirements",
    "content": {
      "fr_id": "FR-009",
      "description": "User can archive their account",
      "requirement": "The system MUST provide an API endpoint POST /api/v1/users/:id/archive that allows users to archive their account. Archived accounts are hidden from search and login is disabled, but data is retained for 30 days to allow recovery.",
      "rationale": "Users need ability to deactivate without full deletion for GDPR compliance."
    }
  },
  "secondary_changes": [
    {
      "type": "ADD_ANNOTATION",
      "file": "src/api/users.ts",
      "line": 142,
      "annotation": "@speckit:FR:FR-009"
    }
  ],
  "impact": {
    "files_affected": ["spec.md", "src/api/users.ts"],
    "traceability": ["FR-009"],
    "risk": "LOW"
  },
  "diff": {
    "format": "unified",
    "content": "--- spec.md\n+++ spec.md\n@@ -45,6 +45,15 @@\n \n ## Functional Requirements\n \n+### FR-009: User Account Archival\n+\n+**Description**: User can archive their account to temporarily deactivate it.\n+\n+**Requirement**: The system MUST provide an API endpoint `POST /api/v1/users/:id/archive` that allows users to archive their account. Archived accounts are hidden from search and login is disabled.\n+\n+**Rationale**: Users need ability to deactivate without full deletion for GDPR compliance.\n+\n+---\n+\n ### FR-001: User Registration\n"
  }
}
```

**Display**:

```text
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Proposal 1/15: ADD_FR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ  HIGH  [+ ADD FR]  âœ“ High (0.82)

## Summary
Add new functional requirement for undocumented API

## Current State
API exists but not documented in spec

Evidence:
  â€¢ Function archiveUser found at src/api/users.ts:142
  â€¢ No @speckit:FR: annotation
  â€¢ No corresponding FR in spec.md
  â€¢ 3 tests reference this function

## Proposed Change
Target: spec.md Â§ Functional Requirements
Action: add

New Functional Requirement:

  FR-009: User can archive their account

  Description:
    The system MUST provide an API endpoint POST /api/v1/users/:id/archive
    that allows users to archive their account. Archived accounts are hidden
    from search and login is disabled, but data is retained for 30 days to
    allow recovery.

  Rationale:
    Users need ability to deactivate without full deletion for GDPR compliance.

  Related:
    â€¢ API: POST /api/v1/users/:id/archive
    â€¢ Implementation: src/api/users.ts:142

## Secondary Changes
  ADD_ANNOTATION â†’ src/api/users.ts:142

## Impact
Files affected: spec.md, src/api/users.ts
Traceability: FR-009
Risk: LOW

## Diff Preview
--- spec.md
+++ spec.md
@@ -45,6 +45,15 @@

 ## Functional Requirements

+### FR-009: User Account Archival
+
+**Description**: User can archive their account to temporarily deactivate it.
+
+**Requirement**: The system MUST provide an API endpoint `POST /api/v1/users/:id/archive`...
+
+**Rationale**: Users need ability to deactivate without full deletion for GDPR compliance.
+
+---
+
 ### FR-001: User Registration

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Apply this change? [Y/n/e/skip/quit]: _
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

### Example 2: UPDATE_FR Proposal (Behavioral Drift)

```json
{
  "id": "PROP-007",
  "type": "UPDATE_FR",
  "artifact": "spec.md",
  "severity": "MEDIUM",
  "confidence": 0.91,
  "source": {
    "type": "behavioral_drift",
    "drift_item_id": "BD-002",
    "file": "src/api/auth.ts",
    "line": 67,
    "symbol": "login"
  },
  "current_state": {
    "description": "Spec says return 401, code returns 403",
    "evidence": [
      "FR-003 specifies: 'MUST return 401 Unauthorized'",
      "Code returns: 403 Forbidden (src/api/auth.ts:67)",
      "Tests expect 403 (not 401)"
    ]
  },
  "proposed_change": {
    "action": "update",
    "target": "spec.md FR-003",
    "content": {
      "fr_id": "FR-003",
      "field": "requirement",
      "old_value": "The system MUST return 401 Unauthorized for invalid credentials.",
      "new_value": "The system MUST return 403 Forbidden for invalid credentials.",
      "rationale": "Code implementation returns 403 (not 401). Updating spec to match reality per 'Code is truth' policy."
    }
  },
  "secondary_changes": [],
  "impact": {
    "files_affected": ["spec.md"],
    "traceability": ["FR-003"],
    "risk": "LOW"
  },
  "diff": {
    "format": "unified",
    "content": "--- spec.md\n+++ spec.md\n@@ -67,1 +67,1 @@\n-**Requirement**: The system MUST return 401 Unauthorized for invalid credentials.\n+**Requirement**: The system MUST return 403 Forbidden for invalid credentials.\n"
  }
}
```

**Display**:

```text
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Proposal 7/15: UPDATE_FR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¡ MEDIUM  [â†» UPDATE FR]  âœ… Very High (0.91)

## Summary
Update FR-003 to match actual code behavior

## Current State
Spec says return 401, code returns 403

Evidence:
  â€¢ FR-003 specifies: 'MUST return 401 Unauthorized'
  â€¢ Code returns: 403 Forbidden (src/api/auth.ts:67)
  â€¢ Tests expect 403 (not 401)

## Proposed Change
Target: spec.md FR-003
Action: update

Modify Existing Requirement:

  FR-003: User authentication via JWT

  Current:
    "The system MUST return 401 Unauthorized for invalid credentials."

  Proposed:
    "The system MUST return 403 Forbidden for invalid credentials."

  Reason:
    Code implementation returns 403 (not 401). Updating spec to match reality
    per 'Code is truth' policy.

## Impact
Files affected: spec.md
Traceability: FR-003
Risk: LOW

## Diff Preview
--- spec.md
+++ spec.md
@@ -67,1 +67,1 @@
-**Requirement**: The system MUST return 401 Unauthorized for invalid credentials.
+**Requirement**: The system MUST return 403 Forbidden for invalid credentials.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Apply this change? [Y/n/e/skip/quit]: _
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

### Example 3: MOVE_FR_TO_OUT_OF_SCOPE Proposal

```json
{
  "id": "PROP-010",
  "type": "MOVE_FR_TO_OUT_OF_SCOPE",
  "artifact": "spec.md",
  "severity": "LOW",
  "confidence": 0.78,
  "source": {
    "type": "forward_drift",
    "drift_item_id": "FD-005",
    "fr_id": "FR-007"
  },
  "current_state": {
    "description": "FR-007 specified but never implemented",
    "evidence": [
      "FR-007: Email notifications for account changes",
      "No implementation found in codebase",
      "No @speckit:FR:FR-007 annotations",
      "No tests for email functionality"
    ]
  },
  "proposed_change": {
    "action": "move",
    "target": "spec.md Â§ Out of Scope",
    "content": {
      "fr_id": "FR-007",
      "description": "Email notifications for account changes",
      "reason": "FR-007 was never implemented in code and has no tests. Moving to Â§ Out of Scope for future consideration.",
      "rationale": "Email service not yet integrated. Defer until Phase 3."
    }
  },
  "secondary_changes": [],
  "impact": {
    "files_affected": ["spec.md"],
    "traceability": ["FR-007"],
    "risk": "LOW"
  },
  "diff": {
    "format": "unified",
    "content": "--- spec.md\n+++ spec.md\n@@ -120,15 +120,0 @@\n-### FR-007: Email Notifications\n-\n-**Description**: Users receive email notifications for account changes.\n-\n-**Requirement**: The system MUST send email notifications when...\n-\n-**Rationale**: Keep users informed of security-relevant changes.\n-\n----\n@@ -200,0 +200,10 @@\n+### FR-007: Email Notifications (Deferred)\n+\n+**Description**: Users receive email notifications for account changes.\n+\n+**Reason**: Email service not yet integrated. Defer until Phase 3.\n+\n+---\n"
  }
}
```

---

### Example 4: ADD_ANNOTATION Proposal

```json
{
  "id": "PROP-002",
  "type": "ADD_ANNOTATION",
  "artifact": "code",
  "severity": "LOW",
  "confidence": 1.0,
  "source": {
    "type": "traceability_gap",
    "fr_id": "FR-009",
    "file": "src/api/users.ts",
    "line": 142,
    "symbol": "archiveUser"
  },
  "current_state": {
    "description": "Function lacks @speckit annotation",
    "evidence": [
      "Function archiveUser implements FR-009",
      "No @speckit:FR: annotation present"
    ]
  },
  "proposed_change": {
    "action": "add",
    "target": "src/api/users.ts:142",
    "content": {
      "annotation": "@speckit:FR:FR-009",
      "comment": "User can archive account"
    }
  },
  "secondary_changes": [],
  "impact": {
    "files_affected": ["src/api/users.ts"],
    "traceability": ["FR-009"],
    "risk": "LOW"
  },
  "diff": {
    "format": "unified",
    "content": "--- src/api/users.ts\n+++ src/api/users.ts\n@@ -141,0 +142,1 @@\n+// @speckit:FR:FR-009 User can archive account\n export async function archiveUser(userId: string) {\n"
  }
}
```

---

### Example 5: ADD_TASK Proposal

```json
{
  "id": "PROP-012",
  "type": "ADD_TASK",
  "artifact": "tasks.md",
  "severity": "HIGH",
  "confidence": 0.95,
  "source": {
    "type": "new_fr",
    "fr_id": "FR-009"
  },
  "current_state": {
    "description": "FR-009 added but no tasks exist",
    "evidence": [
      "FR-009: User Account Archival added to spec",
      "No implementation tasks in tasks.md",
      "No test tasks in tasks.md"
    ]
  },
  "proposed_change": {
    "action": "add",
    "target": "tasks.md Â§ Phase P2a",
    "content": {
      "task_id": "T020",
      "description": "[FR:FR-009] Implement account archival endpoint",
      "phase": "P2a",
      "dependencies": ["T015"],
      "estimated_time": "2h"
    }
  },
  "secondary_changes": [
    {
      "type": "ADD_TEST_TASK",
      "task_id": "T021",
      "description": "[TEST:AS-9A] Test account archival happy path",
      "dependencies": ["T020"]
    }
  ],
  "impact": {
    "files_affected": ["tasks.md"],
    "traceability": ["FR-009", "AS-9A", "T020", "T021"],
    "risk": "LOW"
  },
  "diff": {
    "format": "unified",
    "content": "--- tasks.md\n+++ tasks.md\n@@ -67,0 +68,2 @@\n+- [ ] [FR:FR-009] Implement account archival endpoint [DEP:T015]\n+- [ ] [TEST:AS-9A] Test account archival happy path [DEP:T020]\n"
  }
}
```

---

## Batch Proposals

### Grouping Proposals

Proposals can be grouped for better UX:

```text
GROUP_PROPOSALS(proposals):
  grouped = {
    "spec.md": [],
    "plan.md": [],
    "tasks.md": [],
    "code": []
  }

  FOR proposal IN proposals:
    artifact = proposal.artifact
    grouped[artifact].append(proposal)

  RETURN grouped
```

---

### Batch Display

```text
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Proposal Summary
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Total proposals: 15

By artifact:
  spec.md:  8 proposals (5 ADD_FR, 2 UPDATE_FR, 1 MOVE_FR)
  plan.md:  3 proposals (2 ADD_PHASE, 1 ADD_ADR)
  tasks.md: 4 proposals (3 ADD_TASK, 1 ADD_TEST_TASK)

By severity:
  ğŸ”´ CRITICAL: 0
  ğŸŸ  HIGH:     6
  ğŸŸ¡ MEDIUM:   5
  ğŸŸ¢ LOW:      4

Average confidence: 0.84 (High)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Press Enter to review proposals one by one...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

### Auto-Approve Batch (Auto Mode)

In `--mode auto` with `--force`:

```text
IF mode == "auto" AND force == True:
  FOR proposal IN proposals:
    IF proposal.confidence >= 0.75:
      approved_proposals.append(proposal)
      OUTPUT(f"âœ… Auto-approved: {proposal.id} (confidence: {proposal.confidence})")
    ELSE:
      rejected_proposals.append(proposal)
      OUTPUT(f"âŒ Auto-rejected: {proposal.id} (confidence: {proposal.confidence} < 0.75)")

  OUTPUT(f"\nAuto-approved: {len(approved_proposals)}/{len(proposals)}")
  OUTPUT(f"Auto-rejected: {len(rejected_proposals)}/{len(proposals)}")

  APPLY_PROPOSALS(approved_proposals)
```

---

## Session State Management

### Session State Schema

```yaml
session_id: "fix-session-20260111-103045"
timestamp: "2026-01-11T10:30:45Z"
command: "/speckit.fix --scope src/auth/ --mode interactive"
flags:
  scope: "src/auth/"
  mode: "interactive"
  git_diff: true
  strategy: "incremental"

proposals:
  total: 15
  approved: 7
  rejected: 3
  pending: 5

approved_proposals:
  - PROP-001
  - PROP-002
  - PROP-003
  - PROP-005
  - PROP-007
  - PROP-008
  - PROP-010

rejected_proposals:
  - PROP-004
  - PROP-006
  - PROP-009

pending_proposals:
  - PROP-011
  - PROP-012
  - PROP-013
  - PROP-014
  - PROP-015

current_artifact: "tasks.md"
current_proposal_index: 10

artifacts_completed:
  - "spec.md"
  - "plan.md"

artifacts_pending:
  - "tasks.md"
```

---

### Resume Session

```bash
# Resume interrupted session
/speckit.fix --resume
```

**Logic**:
```text
IF --resume flag:
  session_state = READ(".fix-session.yaml")

  OUTPUT(f"Resuming session: {session_state.session_id}")
  OUTPUT(f"Progress: {len(session_state.approved_proposals)}/{session_state.proposals.total} approved")

  # Skip to pending proposals
  FOR proposal IN session_state.pending_proposals:
    DISPLAY_PROPOSAL(proposal)
    response = HANDLE_USER_RESPONSE(proposal)

  # Apply all approved proposals
  APPLY_PROPOSALS(session_state.approved_proposals)
```

---

### Save Session State

```text
SAVE_SESSION_STATE():
  session_state = {
    "session_id": f"fix-session-{NOW()}",
    "timestamp": NOW(),
    "command": ORIGINAL_COMMAND,
    "flags": FLAGS,
    "proposals": {
      "total": len(all_proposals),
      "approved": len(approved_proposals),
      "rejected": len(rejected_proposals),
      "pending": len(pending_proposals)
    },
    "approved_proposals": [p.id for p in approved_proposals],
    "rejected_proposals": [p.id for p in rejected_proposals],
    "pending_proposals": [p.id for p in pending_proposals],
    "current_artifact": current_artifact,
    "current_proposal_index": current_index,
    "artifacts_completed": artifacts_completed,
    "artifacts_pending": artifacts_pending
  }

  WRITE(".fix-session.yaml", YAML_STRINGIFY(session_state))
  OUTPUT("âœ… Session state saved to .fix-session.yaml")
```

---

## Integration Points

### With Wave 3: Proposal Generation

```text
# spec-proposer subagent (Wave 3)

OUTPUT:
  proposals = [
    {PROPOSAL_001},
    {PROPOSAL_002},
    ...
  ]

  WRITE(".fix-session/wave3-proposals-spec.json", JSON_STRINGIFY(proposals))
```

---

### With Wave 4: User Interaction

```text
# interactive-reviewer subagent (Wave 4)

INPUT:
  proposals = READ(".fix-session/wave3-proposals-spec.json")

PROCESS:
  FOR proposal IN proposals:
    DISPLAY_PROPOSAL(proposal)
    response = HANDLE_USER_RESPONSE(proposal)

    IF response == "cancel_session":
      SAVE_SESSION_STATE()
      EXIT(0)

OUTPUT:
  approved = [p.id for p in approved_proposals]
  rejected = [p.id for p in rejected_proposals]

  WRITE(".fix-session/wave4-approved-proposals.json", JSON_STRINGIFY(approved))
  WRITE(".fix-session/wave4-rejected-proposals.json", JSON_STRINGIFY(rejected))
```

---

### With Wave 5: Application

```text
# artifact-updater subagent (Wave 5)

INPUT:
  approved_ids = READ(".fix-session/wave4-approved-proposals.json")
  all_proposals = READ(".fix-session/wave3-proposals-spec.json")

  approved_proposals = FILTER(all_proposals, id IN approved_ids)

PROCESS:
  FOR proposal IN approved_proposals:
    APPLY_PROPOSAL(proposal)

OUTPUT:
  WRITE(".fix-session/wave5-applied-changes.json", JSON_STRINGIFY(changes))
```

---

## Preview Mode

In `--mode preview`, generate proposal report without user interaction:

```text
IF mode == "preview":
  proposals = GENERATE_ALL_PROPOSALS()

  report = GENERATE_PREVIEW_REPORT(proposals)

  WRITE("fix-preview.md", report)

  OUTPUT("âœ… Preview report generated: fix-preview.md")
  OUTPUT("Review proposals and run with --mode interactive to apply")

  EXIT(0)
```

---

### Preview Report Format

```markdown
# Drift Fix Proposal Report

**Generated**: 2026-01-11 10:30:45
**Scope**: src/auth/
**Strategy**: incremental

---

## Summary

Total proposals: 15

By artifact:
  - spec.md:  8 proposals
  - plan.md:  3 proposals
  - tasks.md: 4 proposals

By severity:
  - CRITICAL: 0
  - HIGH:     6
  - MEDIUM:   5
  - LOW:      4

Average confidence: 0.84 (High)

---

## Proposals

### PROP-001: ADD_FR

**Artifact**: spec.md
**Severity**: HIGH
**Confidence**: 0.82

**Summary**: Add new functional requirement for undocumented API

**Current State**: API exists but not documented

**Proposed Change**:
- Add FR-009: User Account Archival
- Add annotation @speckit:FR:FR-009 to src/api/users.ts:142

**Impact**: spec.md, src/api/users.ts

---

### PROP-002: ADD_ANNOTATION

...

---

## Next Steps

1. Review proposals above
2. Run `/speckit.fix --mode interactive` to apply changes
3. Or run `/speckit.fix --mode auto --force` to auto-apply (confidence >= 0.75)
```

---

## Error Handling

### Invalid Proposal Format

```text
VALIDATE_PROPOSAL(proposal):
  required_fields = ["id", "type", "artifact", "severity", "confidence",
                     "source", "current_state", "proposed_change", "impact"]

  FOR field IN required_fields:
    IF field NOT IN proposal:
      ERROR(f"Missing required field: {field}")
      RETURN False

  IF proposal.confidence < 0.0 OR proposal.confidence > 1.0:
    ERROR("Confidence must be between 0.0 and 1.0")
    RETURN False

  IF proposal.type NOT IN VALID_PROPOSAL_TYPES:
    ERROR(f"Invalid proposal type: {proposal.type}")
    RETURN False

  RETURN True
```

---

### Conflicting Proposals

```text
DETECT_CONFLICTS(proposals):
  conflicts = []

  FOR i, p1 IN enumerate(proposals):
    FOR j, p2 IN enumerate(proposals[i+1:]):
      IF CONFLICTS(p1, p2):
        conflicts.append((p1.id, p2.id))

  RETURN conflicts

CONFLICTS(p1, p2):
  # Same FR ID being added/updated
  IF p1.type == "ADD_FR" AND p2.type == "ADD_FR":
    IF p1.proposed_change.content.fr_id == p2.proposed_change.content.fr_id:
      RETURN True

  # Same file/line being annotated
  IF p1.type == "ADD_ANNOTATION" AND p2.type == "ADD_ANNOTATION":
    IF p1.source.file == p2.source.file AND p1.source.line == p2.source.line:
      RETURN True

  RETURN False
```

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-11 | Initial version with proposal schema and display formats |

---

## References

- `/speckit.fix` command template: `templates/commands/speckit.fix.md`
- Fix strategies: `templates/shared/drift/fix-strategies.md`
- Drift detection: `templates/shared/drift/drift-detection.md`

---

**End of Proposal Template**
